#include <stdlib.h>
#include <stdint.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <arpa/inet.h>
#include <ppm.h>
#include <assert.h>
#include "image.h"

static const uint8_t font[96][14] =
{
  { // space
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // !
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // "
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // #
    0b01100110,
    0b01100110,
    0b11111111,
    0b11111111,
    0b01100110,
    0b01100110,
    0b11111111,
    0b11111111,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // $
    0b00111110,
    0b01111110,
    0b01100000,
    0b01100000,
    0b01111100,
    0b00111110,
    0b00000110,
    0b00000110,
    0b01111110,
    0b01111100,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // %
    0b01100110,
    0b01100110,
    0b01101100,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00110110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // &
    0b01101100,
    0b01101100,
    0b00111000,
    0b00111000,
    0b01110000,
    0b01110000,
    0b11011110,
    0b11011110,
    0b11001100,
    0b11001100,
    0b11111110,
    0b01110110,
    0b00000000,
    0b00000000,
  },
  { // '
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // (
    0b00000110,
    0b00001100,
    0b00011100,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011100,
    0b00001100,
    0b00000110,
    0b00000000,
    0b00000000,
  },
  { // )
    0b01100000,
    0b00110000,
    0b00111000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00111000,
    0b00110000,
    0b01100000,
    0b00000000,
    0b00000000,
  },
  { // *
    0b01100110,
    0b01100110,
    0b00111100,
    0b00111100,
    0b11111111,
    0b11111111,
    0b00111100,
    0b00111100,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // +
    0b00000000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b01111110,
    0b01111110,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // ,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00100000,
  },
  { // -
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // .
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // /
    0b00000110,
    0b00000110,
    0b00000110,
    0b00001100,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00110000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b00000000,
    0b00000000,
  },
  { // 0
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01101110,
    0b01110110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // 1
    0b00011000,
    0b00011000,
    0b00111000,
    0b00111000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
  },
  { // 2
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b00001100,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00110000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
  },
  { // 3
    0b01111110,
    0b01111110,
    0b00001100,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00001100,
    0b00001100,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // 4
    0b00001100,
    0b00001100,
    0b00011100,
    0b00011100,
    0b00111100,
    0b00111100,
    0b01101100,
    0b01101100,
    0b01111110,
    0b01111110,
    0b00001100,
    0b00001100,
    0b00000000,
    0b00000000,
  },
  { // 5
    0b01111110,
    0b01111110,
    0b01100000,
    0b01100000,
    0b01111100,
    0b01111110,
    0b00000110,
    0b00000110,
    0b00000110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // 6
    0b00011100,
    0b00111100,
    0b01110000,
    0b01100000,
    0b01100000,
    0b01111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // 7
    0b01111110,
    0b01111110,
    0b00000110,
    0b00000110,
    0b00001100,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00110000,
    0b00110000,
    0b00110000,
    0b00000000,
    0b00000000,
  },
  { // 8
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b00111100,
    0b00111100,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // 9
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111110,
    0b00000110,
    0b00000110,
    0b00000110,
    0b00001110,
    0b00111100,
    0b00111000,
    0b00000000,
    0b00000000,
  },
  { // :
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // ;
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00100000,
  },
  { // <
    0b00000000,
    0b00001110,
    0b00011100,
    0b00111000,
    0b01110000,
    0b11100000,
    0b01110000,
    0b00111000,
    0b00011100,
    0b00001110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // =
    0b00000000,
    0b00000000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // >
    0b00000000,
    0b11100000,
    0b01110000,
    0b00111000,
    0b00011100,
    0b00001110,
    0b00011100,
    0b00111000,
    0b01110000,
    0b11100000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // ?
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b00001100,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // @
    0b00111000,
    0b01111100,
    0b11100110,
    0b11000010,
    0b11011010,
    0b11010110,
    0b11010110,
    0b11011100,
    0b11000000,
    0b11100010,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // A
    0b00011000,
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
  },
  { // B
    0b01111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01111100,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01111100,
    0b00000000,
    0b00000000,
  },
  { // C
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // D
    0b01111000,
    0b01111100,
    0b01101110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01101110,
    0b01111100,
    0b01111000,
    0b00000000,
    0b00000000,
  },
  { // E
    0b01111110,
    0b01111110,
    0b01100000,
    0b01100000,
    0b01111100,
    0b01111100,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
  },
  { // F
    0b01111110,
    0b01111110,
    0b01100000,
    0b01100000,
    0b01111100,
    0b01111100,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b00000000,
    0b00000000,
  },
  { // G
    0b00111110,
    0b01111110,
    0b01100000,
    0b01100000,
    0b01101110,
    0b01101110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // H
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
  },
  { // I
    0b01111110,
    0b01111110,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
  },
  { // J
    0b00000110,
    0b00000110,
    0b00000110,
    0b00000110,
    0b00000110,
    0b00000110,
    0b00000110,
    0b00000110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // K
    0b11001100,
    0b11001100,
    0b11011000,
    0b11011000,
    0b11110000,
    0b11110000,
    0b11011000,
    0b11011000,
    0b11001100,
    0b11001100,
    0b11000110,
    0b11000110,
    0b00000000,
    0b00000000,
  },
  { // L
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
  },
  { // M
    0b11000110,
    0b11000110,
    0b11101110,
    0b11101110,
    0b11111110,
    0b11010110,
    0b11010110,
    0b11000110,
    0b11000110,
    0b11000110,
    0b11000110,
    0b11000110,
    0b00000000,
    0b00000000,
  },
  { // N
    0b01100110,
    0b01100110,
    0b01100110,
    0b01110110,
    0b01110110,
    0b01111110,
    0b01111110,
    0b01101110,
    0b01101110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
  },
  { // O
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // P
    0b01111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01111100,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b00000000,
    0b00000000,
  },
  { // Q
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01101010,
    0b01111100,
    0b00110110,
    0b00000000,
    0b00000000,
  },
  { // R
    0b11111000,
    0b11111100,
    0b11001100,
    0b11001100,
    0b11001100,
    0b11111100,
    0b11111000,
    0b11011000,
    0b11001100,
    0b11001100,
    0b11000110,
    0b11000110,
    0b00000000,
    0b00000000,
  },
  { // S
    0b00111110,
    0b01111110,
    0b01100000,
    0b01100000,
    0b01110000,
    0b00111000,
    0b00011100,
    0b00001110,
    0b00000110,
    0b00000110,
    0b01111110,
    0b01111100,
    0b00000000,
    0b00000000,
  },
  { // T
    0b01111110,
    0b01111110,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // U
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // V
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00111100,
    0b00111100,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // W
    0b11000110,
    0b11000110,
    0b11000110,
    0b11000110,
    0b11000110,
    0b11010110,
    0b11010110,
    0b11111110,
    0b11111110,
    0b11101110,
    0b11000110,
    0b10000010,
    0b00000000,
    0b00000000,
  },
  { // X
    0b01100110,
    0b01100110,
    0b01100110,
    0b00111100,
    0b00111100,
    0b00011000,
    0b00011000,
    0b00111100,
    0b00111100,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
  },
  { // Y
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00111100,
    0b00111100,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // Z
    0b01111110,
    0b01111110,
    0b00001100,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00110000,
    0b01100000,
    0b01100000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
  },
  { // [
    0b00011110,
    0b00011110,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011110,
    0b00011110,
    0b00000000,
    0b00000000,
  },
  { // backslash
    0b01100000,
    0b01100000,
    0b01100000,
    0b00110000,
    0b00110000,
    0b00011000,
    0b00011000,
    0b00001100,
    0b00001100,
    0b00000110,
    0b00000110,
    0b00000110,
    0b00000000,
    0b00000000,
  },
  { // ]
    0b01111000,
    0b01111000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b01111000,
    0b01111000,
    0b00000000,
    0b00000000,
  },
  { // ^
    0b00010000,
    0b00111000,
    0b00111000,
    0b01101100,
    0b01101100,
    0b11000110,
    0b11000110,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // _
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b11111110,
    0b11111110,
    0b00000000,
    0b00000000,
  },
  { // `
    0b01110000,
    0b00111000,
    0b00011100,
    0b00001100,
    0b00000100,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
  { // a
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111100,
    0b00111110,
    0b00000110,
    0b00111110,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111110,
    0b00000000,
    0b00000000,
  },
  { // b
    0b01100000,
    0b01100000,
    0b01100000,
    0b01111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01111100,
    0b00000000,
    0b00000000,
  },
  { // c
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111100,
    0b01111100,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01111110,
    0b00111110,
    0b00000000,
    0b00000000,
  },
  { // d
    0b00000110,
    0b00000110,
    0b00000110,
    0b00111110,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111110,
    0b00000000,
    0b00000000,
  },
  { // e
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01100000,
    0b01100000,
    0b01111110,
    0b00111110,
    0b00000000,
    0b00000000,
  },
  { // f
    0b00001110,
    0b00011110,
    0b00011000,
    0b00011000,
    0b01111110,
    0b01111110,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // g
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111110,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111110,
    0b00000110,
    0b01111110,
    0b01111100,
  },
  { // h
    0b01100000,
    0b01100000,
    0b01100000,
    0b01111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
  },
  { // i
    0b00011000,
    0b00011000,
    0b00000000,
    0b00111000,
    0b00111000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00111100,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // j
    0b00001100,
    0b00001100,
    0b00000000,
    0b00001100,
    0b00001100,
    0b00001100,
    0b00001100,
    0b00001100,
    0b00001100,
    0b00001100,
    0b00001100,
    0b00001100,
    0b01111100,
    0b01111000,
  },
  { // k
    0b11000000,
    0b11000000,
    0b11000000,
    0b11001100,
    0b11011100,
    0b11111000,
    0b11110000,
    0b11111000,
    0b11011000,
    0b11001100,
    0b11001110,
    0b11000110,
    0b00000000,
    0b00000000,
  },
  { // l
    0b00111000,
    0b00111000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00111100,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // m
    0b00000000,
    0b00000000,
    0b00000000,
    0b01101100,
    0b11111110,
    0b11111110,
    0b11010110,
    0b11010110,
    0b11010110,
    0b11000110,
    0b11000110,
    0b11000110,
    0b00000000,
    0b00000000,
  },
  { // n
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
  },
  { // o
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  { // p
    0b00000000,
    0b00000000,
    0b00000000,
    0b01111100,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b01111100,
    0b01100000,
    0b01100000,
  },
  { // q
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111110,
    0b01111110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111110,
    0b00000110,
    0b00000110,
  },
  { // r
    0b00000000,
    0b00000000,
    0b00000000,
    0b01111100,
    0b01111110,
    0b01100110,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b01100000,
    0b00000000,
    0b00000000,
  },
  { // s
    0b00000000,
    0b00000000,
    0b00000000,
    0b00111110,
    0b01111110,
    0b01100000,
    0b01110000,
    0b00111100,
    0b00001110,
    0b00000110,
    0b01111110,
    0b01111100,
    0b00000000,
    0b00000000,
  },
  { // t
    0b00000000,
    0b00011000,
    0b00011000,
    0b01111110,
    0b01111110,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011110,
    0b00001110,
    0b00000000,
    0b00000000,
  },
  { // u
    0b00000000,
    0b00000000,
    0b00000000,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111110,
    0b00000000,
    0b00000000,
  },
  { // v
    0b00000000,
    0b00000000,
    0b00000000,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b00111100,
    0b00111100,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
  },
  { // w
    0b00000000,
    0b00000000,
    0b00000000,
    0b11000110,
    0b11000110,
    0b11010110,
    0b11010110,
    0b11111110,
    0b11111110,
    0b11101110,
    0b11000110,
    0b10000010,
    0b00000000,
    0b00000000,
  },
  { // x
    0b00000000,
    0b00000000,
    0b00000000,
    0b01100110,
    0b01100110,
    0b00111100,
    0b00111100,
    0b00011000,
    0b00111100,
    0b00111100,
    0b01100110,
    0b01100110,
    0b00000000,
    0b00000000,
  },
  { // y
    0b00000000,
    0b00000000,
    0b00000000,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01100110,
    0b01111110,
    0b00111110,
    0b00000110,
    0b01111110,
    0b01111100,
  },
  { // z
    0b00000000,
    0b00000000,
    0b00000000,
    0b01111110,
    0b01111110,
    0b00001100,
    0b00011000,
    0b00011000,
    0b00110000,
    0b00110000,
    0b01111110,
    0b01111110,
    0b00000000,
    0b00000000,
  },
  { // {
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00111000,
    0b11110000,
    0b11110000,
    0b00111000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00001110,
    0b00000000,
  },
  { // |
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00000000,
  },
  { // }
    0b00110000,
    0b00110000,
    0b00110000,
    0b00110000,
    0b00111000,
    0b00011110,
    0b00011110,
    0b00111000,
    0b00110000,
    0b00110000,
    0b00110000,
    0b00110000,
    0b11100000,
    0b00000000,
  },
  { // ~
    0b00000000,
    0b00000000,
    0b00000000,
    0b01100010,
    0b11110010,
    0b10111110,
    0b10011100,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
  },
};

static uint16_t colors_to_pixel(int red, int green, int blue)
{
  assert(red >= 0 && red <= 255);
  assert(green >= 0 && green <= 255);
  assert(blue >= 0 && blue <= 255);
  return htons(((red & 0xf8) << 8) + ((green & 0xfc) << 3) + (blue >> 3));
}

image_t img_create(int width, int height, int red, int green, int blue)
{
  assert(width > 0);
  assert(height > 0);
  uint16_t pixel = colors_to_pixel(red, green, blue);

  image_t img = malloc(sizeof(struct image) + (width * height - 1) * sizeof(uint16_t));
  assert(img);

  img->width = width;
  img->height = height;
  for (int index = 0; index < width * height; index++)
    img->pixels[index] = pixel;

  return img;
}

image_t img_load_ppm(const char *path)
{
  assert(path);
  FILE *f = fopen(path, "r");
  if (!f)
    return NULL;

  int width, height, format;
  pixval maxval;
  ppm_readppminit(f, &width, &height, &maxval, &format);

  image_t img = malloc(sizeof(struct image) + (width * height - 1) * sizeof(uint16_t));
  assert(img);
  img->width = width;
  img->height = height;

  pixel *data = ppm_allocrow(width);
  for (int y = 0; y < height; y++)
  {
    ppm_readppmrow(f, data, width, maxval, format);
    for (int x = 0; x < width; x++)
    {
      int red = PPM_GETR(data[x]);
      int green  = PPM_GETG(data[x]);
      int blue  = PPM_GETB(data[x]);
      img->pixels[x + width * y] = colors_to_pixel(red, green, blue);
    }
  }
  ppm_freerow(data);
  fclose(f);

  return img;
}

image_t img_read(const char *path)
{
  struct image header;
  int fd = open(path, O_RDONLY);
  int len = read(fd, &header, sizeof(struct image) - sizeof(uint16_t));
  assert(len == sizeof(struct image) - sizeof(uint16_t));
  int size = header.width * header.height * sizeof(uint16_t);
  image_t img = malloc(sizeof(struct image) - sizeof(uint16_t) + size);
  assert(img);
  img->width = header.width;
  img->height = header.height;
  len = read(fd, img->pixels, size);
  assert(len == size);
  close(fd);
  return img;
}

void img_write(image_t img, const char *path)
{
  int size = sizeof(struct image) + (img->width * img->height - 1) * sizeof(uint16_t);
  int fd = open(path, O_CREAT | O_TRUNC | O_WRONLY, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);
  assert(fd);
  int len = write(fd, img, size);
  assert(len == size);
  close(fd);
}

void img_draw_rectangle(image_t img, int x, int y, int width, int height,
  int red, int green, int blue)
{
  assert(img);
  assert(x >= 0 && x + width <= img->width);
  assert(y >= 0 && y + height <= img->height);
  uint16_t pixel = colors_to_pixel(red, green, blue);

  for (int yy = y; yy < y + height; yy++)
    for (int xx = x; xx < x + width; xx++)
      img->pixels[xx + img->width * yy] = pixel;
}

void img_draw_line(image_t img, int x, int y, int xx, int yy,
  int red, int green, int blue)
{
  assert(img);
  assert(x >= 0 && x < img->width);
  assert(y >= 0 && y < img->height);
  assert(xx >= 0 && xx < img->width);
  assert(yy >= 0 && yy < img->height);
  uint16_t pixel = colors_to_pixel(red, green, blue);

  if (abs(x - xx) >= abs(y - yy))
    if (x <= xx)
      for (int xxx = x; xxx <= xx; xxx++)
      {
	int yyy = y + (yy - y) * (xxx - x) / (xx - x);
	img->pixels[xxx + img->width * yyy] = pixel;
      }
    else // xx < x
      for (int xxx = xx; xxx <= x; xxx++)
      {
	int yyy = yy + (y - yy) * (xxx - xx) / (x - xx);
	img->pixels[xxx + img->width * yyy] = pixel;
      }
  else
    if (y <= yy)
      for (int yyy = y; yyy <= yy; yyy++)
      {
	int xxx = x + (xx - x) * (yyy - y) / (yy - y);
	img->pixels[xxx + img->width * yyy] = pixel;
      }
    else
      for (int yyy = yy; yyy <= y; yyy++)
      {
	int xxx = xx + (x - xx) * (yyy - yy) / (y - yy);
	img->pixels[xxx + img->width * yyy] = pixel;
      }
}

void img_print_text(image_t img, int x, int y, const char *text,
  int red, int green, int blue)
{
  assert(img);
  assert(text);
  assert(x >= 0 && x + 9 * strlen(text) <= img->width);
  assert(y >= 0 && y + 14 <= img->height);
  uint16_t pixel = colors_to_pixel(red, green, blue);

  for (const char *pos = text; *pos; pos++)
  {
    int index = *pos - ' ';
    assert(index >= 0 && index < 96);

    for (int yy = 0; yy < 14; yy++)
      for (int xx = 0; xx < 8; xx++)
      {
	uint8_t bits = font[index][yy] << xx;
	if (!bits)
	  break;
	if (bits & 0x80)
	  img->pixels[x + xx + (y + yy) * img->width] = pixel;
      }
    x += 9;
  }
}

void img_free(image_t img)
{
  assert(img);
  free(img);
}
